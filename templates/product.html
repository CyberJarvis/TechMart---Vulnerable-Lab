{% extends "base.html" %}

{% block title %}{{ product[1] }} - TechMart{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-body text-center">
                <div class="bg-light d-flex align-items-center justify-content-center" style="height: 300px;">
                    <i class="fas fa-laptop fa-5x text-primary"></i>
                </div>
                <div class="mt-3">
                    <span class="badge bg-success">In Stock</span>
                    <span class="badge bg-info">Free Shipping</span>
                    <div class="mt-2">
                        <button class="btn btn-sm btn-outline-secondary" onclick="checkLiveStock({{ product[0] }})">
                            <i class="fas fa-sync-alt"></i> Check Live Stock
                        </button>
                        <div id="liveStockResult" class="mt-2" style="display: none;">
                            <small class="text-muted">Live stock: <span id="liveStockCount">--</span> items</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <h1>{{ product[1] }}</h1>
        <p class="lead text-muted">{{ product[2] }}</p>
        <h3 class="text-success mb-3">
            <i class="fas fa-dollar-sign"></i>{{ "%.2f"|format(product[3]) }}
            <small class="text-muted fs-6">Free shipping on orders over $50</small>
        </h3>
        
        <div class="mb-3">
            <i class="fas fa-star text-warning"></i>
            <i class="fas fa-star text-warning"></i>
            <i class="fas fa-star text-warning"></i>
            <i class="fas fa-star text-warning"></i>
            <i class="fas fa-star-half-alt text-warning"></i>
            <span class="ms-2">4.5/5 (128 reviews)</span>
        </div>
        
        {% if session.user_id %}
        <div class="card mt-4">
            <div class="card-header">
                <h5><i class="fas fa-shopping-cart"></i> Add to Cart</h5>
            </div>
            <div class="card-body">
                <form action="{{ url_for('add_to_cart') }}" method="post">
                    <input type="hidden" name="product_id" value="{{ product[0] }}">
                    
                    <div class="mb-3">
                        <label for="quantity" class="form-label">Quantity:</label>
                        <input type="number" class="form-control" id="quantity" name="quantity" value="1" min="1" max="10">
                    </div>
                    
                    <div class="row">
                        <div class="col-md-8">
                            <button type="submit" class="btn btn-primary btn-lg w-100">
                                <i class="fas fa-cart-plus"></i> Add to Cart
                            </button>
                        </div>
                        <div class="col-md-4">
                            <a href="{{ url_for('view_cart') }}" class="btn btn-outline-success btn-lg w-100">
                                <i class="fas fa-shopping-cart"></i> View Cart
                            </a>
                        </div>
                    </div>
                </form>
                
                <div class="text-center mt-2">
                    <small class="text-muted">
                        <i class="fas fa-tag text-success"></i> Apply coupon codes at checkout!
                        <br>Try: SAVE10, WELCOME20, MEGA50
                    </small>
                </div>
            </div>
        </div>
        {% else %}
        <div class="alert alert-info">
            <a href="{{ url_for('login') }}">Login</a> to purchase this product.
        </div>
        {% endif %}
    </div>
</div>

<!-- Comments Section -->
<div class="row mt-5">
    <div class="col-12">
        <h3><i class="fas fa-comments"></i> Customer Reviews & Questions</h3>
        <hr>
        
        {% if session.user_id %}
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5><i class="fas fa-comment-alt"></i> Leave a Comment</h5>
            </div>
        <!-- Customer Reviews Section -->
        <div class="card mt-4">
            <div class="card-header">
                <h5><i class="fas fa-comments"></i> Customer Reviews</h5>
            </div>
            <div class="card-body">
                <form action="{{ url_for('add_comment') }}" method="post">
                    <input type="hidden" name="product_id" value="{{ product[0] }}">
                    
                    <!-- VULNERABILITY: BAC - Hidden username field that can be manipulated -->
                    <!-- Users can intercept this request and change username to impersonate others -->
                    <input type="hidden" name="username" value="{{ session.username }}" id="hidden-username">
                    
                    <div class="mb-3">
                        <label for="comment" class="form-label">Write your review:</label>
                        <textarea class="form-control" name="comment" id="comment" rows="3" 
                                  placeholder="Share your experience with this product..." required></textarea>
                    </div>
                    
                    <!-- Optional: Show current user (for educational purposes) -->
                    <div class="mb-3">
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i> 
                            Posting as: <span id="current-user">{{ session.username }}</span>
                        </small>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-star"></i> Submit Review
                    </button>
                </form>
            </div>
        </div>
        {% endif %}
        
        <!-- Display Customer Reviews -->
        <div class="reviews-section mt-4">
            <h5><i class="fas fa-star"></i> Customer Reviews ({{ comments|length }})</h5>
            {% for comment in comments %}
            <div class="card mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <h6 class="card-title">
                            <!-- VULNERABILITY: BAC - Shows impersonated username if provided -->
                            <i class="fas fa-user-circle"></i> 
                            <span class="comment-username">{{ comment[6] }}</span>
                            {% if comment[7] == 'admin' %}
                                <span class="badge bg-danger ms-1">ADMIN</span>
                            {% elif comment[7] == 'moderator' %}
                                <span class="badge bg-warning ms-1">MOD</span>
                            {% endif %}
                            {% if comment[5] and comment[5] != '' %}
                                <small class="text-muted">(impersonated)</small>
                            {% endif %}
                        </h6>
                        <small class="text-muted">{{ comment[4] }}</small>
                    </div>
                    <!-- Comment content -->
                    <p class="card-text">{{ comment[3]|safe }}</p>
                    
                    <!-- Show debugging info in development -->
                    {% if config.DEBUG %}
                    <div class="mt-2">
                        <small class="text-muted">
                            <i class="fas fa-bug"></i> Debug: 
                            User ID: {{ comment[2] }}, 
                            Custom Username: {{ comment[4] if comment[4] else 'None' }}
                        </small>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
            
            {% if not comments %}
            <div class="alert alert-secondary">
                <i class="fas fa-info-circle"></i>
                No comments yet. Be the first to leave a review!
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Hidden form for SSRF testing (developers can modify stock_api_url in browser) -->
<div style="display: none;">
    <form id="hiddenStockForm">
        <input type="hidden" id="hidden_stock_api_url" name="stock_api_url" value="https://jsonplaceholder.typicode.com/posts">
        <input type="hidden" id="hidden_product_id" name="product_id" value="">
    </form>
</div>

<script>
function checkLiveStock(productId) {
    // This function demonstrates SSRF vulnerability
    // The stock_api_url can be intercepted and modified to point to malicious endpoints
    
    const resultDiv = document.getElementById('liveStockResult');
    const countSpan = document.getElementById('liveStockCount');
    
    // Show loading state
    resultDiv.style.display = 'block';
    countSpan.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    // Get the "stock API URL" - this is where SSRF happens
    // In a real attack, this URL would be intercepted and changed to webhook/internal service
    const stockApiUrl = document.getElementById('hidden_stock_api_url').value;
    
    const formData = new FormData();
    formData.append('stock_api_url', stockApiUrl);  // VULNERABLE: Attacker can control this URL
    formData.append('product_id', productId);
    
    console.log('[SSRF Debug] Making request to:', stockApiUrl);
    
    fetch('/check_stock_api', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        console.log('[SSRF Debug] Response:', data);
        
        if (data.success) {
            countSpan.innerHTML = data.stock;
            countSpan.className = 'text-success fw-bold';
        } else {
            countSpan.innerHTML = 'Error';
            countSpan.className = 'text-danger';
            console.error('[SSRF Debug] Error:', data.error);
        }
    })
    .catch(error => {
        countSpan.innerHTML = 'Failed';
        countSpan.className = 'text-danger';
        console.error('[SSRF Debug] Request failed:', error);
    });
}

// For penetration testing: This allows easy modification of the target URL
// In browser console, run: document.getElementById('hidden_stock_api_url').value = 'https://webhook.site/your-uuid'
console.log('[SSRF Info] To test SSRF, modify hidden_stock_api_url value to your webhook/target URL');

</script>
{% endblock %}
